# Web界面API Key使用说明

## 新功能：前端API Key输入

现在你可以直接在Web界面上输入MiniMax API Key，无需设置环境变量！

## 使用步骤

### 1. 访问Web界面
打开浏览器访问: **http://localhost:5445**

### 2. 上传文件
- **视频文件**: 选择MP4/AVI/MOV/MKV格式的视频
- **SRT字幕文件**: 选择对应的SRT字幕文件

### 3. 输入API Key（可选）
在"MiniMax API Key"输入框中：
- **输入API Key**: 启用VLM智能命名功能
  - 系统会自动为识别出的人物生成中文姓名
  - 分析角色定位、性别、外观特征
  - 提供性格分析和人物关系推断

- **留空**: 仅进行人脸检测和聚类
  - 系统会识别出所有说话人
  - 使用默认命名 (Speaker 1, Speaker 2, ...)
  - 不会调用VLM API

**安全提示**:
- 点击 👁️ 图标可以显示/隐藏API Key
- API Key默认以密码形式隐藏

### 4. 开始处理
点击"开始处理"按钮，系统会：
1. 上传文件到服务器
2. 解析SRT字幕
3. 抽取视频关键帧
4. 检测并过滤人脸
5. 提取人脸特征
6. DBSCAN聚类识别说话人
7. 生成代表人脸图片
8. **（如果提供了API Key）调用VLM进行智能命名**
9. 展示最终结果

### 5. 查看结果
处理完成后，你可以看到：
- 识别人数统计
- 对话片段数量
- 检测到的人脸总数
- 每个说话人的详细信息：
  - 姓名（VLM命名或默认）
  - 角色定位（主角/配角等，仅VLM）
  - 性别（仅VLM）
  - 外观特征（仅VLM）
  - 代表人脸图片
  - 对话片段数量

## VLM命名对比

### 没有API Key（默认模式）
```
Speaker 1: 45张人脸, 20个片段
Speaker 2: 38张人脸, 18个片段
Speaker 3: 22张人脸, 10个片段
...
```

### 提供API Key（智能命名）
```
阮娇 [主角] (女, 20-30岁): 225张人脸, 62个片段
  外观: 白色上衣搭配黑色裙子，佩戴珍珠项链
  性格: 强势、自信

裴宴 [重要配角] (男, 20-30岁): 206张人脸, 63个片段
  外观: 西装革履，面容英俊
  性格: 冷静、理智

小叔 [重要配角] (男, 30-40岁): 73张人脸, 21个片段
  外观: 西装革履，戴眼镜
  性格: 严厉、权威
...
```

## 服务器日志

### 启用VLM时的日志输出

当你在前端输入API Key后，服务器日志会显示：

```
✅ 检测到API Key（来源: 前端输入），将启用VLM命名
[80%] 调用VLM进行人物命名...

调用MiniMax VLM...
  API: https://api.minimaxi.com/v1/text/chatcompletion_v2
  模型: MiniMax-Text-01
  图片数量: 10
  Prompt长度: 12345 字符
  Trace-ID: 01234567-89ab-cdef-0123-456789abcdef
  HTTP状态码: 200
✓ VLM调用成功
  Trace-ID: 01234567-89ab-cdef-0123-456789abcdef
  返回内容长度: 5678 字符
```

### 未提供API Key时的日志

```
⚠️  未提供API Key，跳过VLM命名
```

## 技术实现

### 前端 (index.html)
- 添加了API Key输入框（password类型）
- 显示/隐藏切换功能
- 通过FormData发送API Key到后端

### 后端 (app.py)
- 接收前端传来的API Key（使用`Form`参数）
- 优先使用前端API Key，其次使用环境变量
- 将API Key传递给处理Pipeline
- 在日志中标注API Key来源

### Pipeline (pipeline.py)
- 根据API Key是否存在决定是否调用VLM
- 增强的错误处理和Trace-ID日志

## 常见问题

### Q: API Key会被保存吗？
A: **不会**。API Key仅在当前任务中使用，处理完成后不会持久化存储。

### Q: 可以同时使用环境变量和前端输入吗？
A: 可以。前端输入的API Key优先级更高。

### Q: 如何查看Trace-ID？
A:
1. 方式1: 查看服务器后台日志
2. 方式2: 如果你是在终端运行服务器，直接看终端输出

### Q: VLM调用失败了怎么办？
A: 检查日志中的Trace-ID和错误详情，常见原因：
- API Key错误或过期
- 网络连接问题
- API配额不足

## 当前服务器

- **地址**: http://localhost:5445
- **状态**: 🟢 运行中
- **API Key支持**: ✅ 前端输入 + 环境变量
- **Trace-ID日志**: ✅ 已启用

## 开始使用

立即访问: **http://localhost:5445**

上传你的视频和字幕，输入API Key，体验智能命名功能！
